<!-- https://stackoverflow.com/questions/1007965/how-to-organize-page-layout-with-divs -->

<html>
    <head>
        <title>Paul's Puzzle Page</title>
        <link rel="stylesheet" type="text/css" href="styles.css">
    </head>
    <body>
        <div id=header>
                <h1>Sudoku</h1>
        </div>
        <div id=middle>

            <div class=columns id=sidebar>
                Chose your difficulty:<br/>
                <select id=level onchange="genBoard()">
                    <option value=1>1</option>
                    <option value=2>2</option>
                    <option value=3>3</option>
                    <option value=4>4</option>
                    <option value=5>5</option>
                </select>
            </div>
            
            <div class=columns id=gameWrapper>
                <div id=game> 
                    GAME GOES HERE
                </div>
            </div>

            <div class=columns id=numbers>
                    <br/>
                    <br/>
                    <br/>
                    <button type="button" id=newGame onclick="genBoard()">
                        New Game
                    </button>
                    <br/>
                    <br/>
                    <button type="button" id=hint onclick="getHint()">
                        Hint
                    </button>
                    <br/>
                    <br/>
                    Last Move:<br/>
                    <div id="time"></div>
            </div>
            
        </div>

        <div id=footer>
           &weierp;owered by &weierp;aul 
        </div>


        <script>
            function gameWon(){
                if (confirm("You win!\nWould you like to play again?")) {
                    genBoard();
                }
            }

            // gets the cell index and value to enter
            function getHint() {
                var xhttp = new XMLHttpRequest();
                xhttp.open("GET", "functions.php?fn=getHint", true);
                xhttp.send();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var jsonData = JSON.parse(this.responseText);
                        var cell = jsonData['cell'];
                        var value = jsonData['value'];
                        var winner = jsonData['winner'];
                        var element = document.getElementById(cell);
                        element.innerHTML = value;
                        element.parentElement.style.background = 'rgba(209, 194, 31, 1)';
                        resetBG(element.parentElement);
                        if(winner){
                            gameWon();
                        }
                    }
                };
            }

            // sends cell index and value
            // gets true or false
            function checkValue(num) {
                var xhttp = new XMLHttpRequest();
                var value = document.getElementById(num).firstChild.value;
                xhttp.open("GET", "functions.php?fn=checkValue&index="+num+"&value="+value, true);
                xhttp.send();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var jsonData = JSON.parse(this.responseText);
                        var element = document.getElementById(num);
                        if(jsonData['result']){
                            element.innerHTML = value;
                            element.parentElement.style.background = 'rgba(160,190,126,1)';
                            resetBG(element.parentElement);
                        }
                        else{
                            document.getElementById(num).firstChild.value = "";
                            element.firstChild.style.background = 'rgba(200,90,26,1)';
                            resetBG(element.firstChild);
                        }
                        // var date = Date();

                        var date = new Date();
                        var hours = date.getHours()%12;
                        if(hours == 0)
                            hours = 12;
                        var minutes = date.getMinutes();
                        var ampm = "am";
                        if(date.getHours() > 11)
                            ampm = "pm";
                        if (minutes < 10)
                            minutes = "0" + minutes;
                        var month = date.getMonth() + 1;
                        var day = date.getDate();
                        var year = date.getFullYear();
                        var dateString = hours + ":" + minutes + " " + ampm + "<br>" 
                        + month + "/" + day + "/" + year;
                        document.getElementById('time').innerHTML = dateString;

                        var winner = jsonData['winner'];
                        console.log(winner);
                        if(winner){
                            gameWon();
                        }
                    }
                };
            }

            // resets the background
            function resetBG(element){
                    var alpha = 0.9;
                    var color = element.style.background;
                    var commas = [color.indexOf("(") + 1];
                    for(var i = 0; i < color.length; i++){
                        if(color[i] == ',')
                        commas.push(i + 1);
                    }
                    var r = color.substring(commas[0],commas[1]);
                    var g = color.substring(commas[1],commas[2]);
                    var b = color.substring(commas[2],color.length - 1)+",";

                    var fadeEffect =  setInterval(function () {
                        if(alpha < 0)
                            clearInterval(fadeEffect);
                        console.log(element.style.background);
                        element.style.background = "rgba("+r+g+b+alpha+")";
                        alpha = alpha - 0.1;
                        }, 50);
            }

            function getHTML(jsonData) {
                var board = "<table>";
                    var cellCount = 0;
                    for(row = 0; row < 9; row++) {
                        board += "<tr id=row" + row + ">"
                        for(col = 0; col < 9; col++) {
                            if(col == 2 || col == 5){
                                board += "<td class=col3>";
                            }
                            else {
                                board += "<td>";
                            }
                            var digit = jsonData['row'+row][col];
                            if(digit == 0) {
                                board += "<span id='" + cellCount + "' onkeyup=\"checkValue('" + cellCount + "')\"><input type='text' class=numInput></span>";
                            }
                            else {
                                board += digit;
                            }
                            cellCount++;
                            board += "</td>"
                        }
                        board += "</tr>"
                    }
                board += "</table>";
                return board;
            }

            // sends level
            // gets board as json
                // row0 : [<cols>],
                // row1 : [<cols>]
            function genBoard() {
                var xhttp = new XMLHttpRequest();
                var levelElement = document.getElementById("level");
                var level = levelElement.options[levelElement.selectedIndex].text;
                xhttp.open("GET", "functions.php?fn=genBoard&level="+level, true);
                xhttp.send();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var jsonData = JSON.parse(this.responseText);
                        var board = getHTML(jsonData);
                    /*
                        var board = "<table>";
                        var cellCount = 0;
                        for(row = 0; row < 9; row++) {
                            board += "<tr id=row" + row + ">"
                            for(col = 0; col < 9; col++) {
                                if(col == 2 || col == 5){
                                    board += "<td class=col3>";
                                }
                                else {
                                    board += "<td>";
                                }
                                var digit = jsonData['row'+row][col];
                                if(digit == 0) {
                                    board += "<span id='" + cellCount + "' onkeyup=\"checkValue('" + cellCount + "')\"><input type='text' class=numInput></span>";
                                }
                                else {
                                    board += digit;
                                }
                                cellCount++;
                                board += "</td>"
                            }
                            board += "</tr>"
                        }
                        board += "</table>";
                    */
                        document.getElementById("game").innerHTML = board;
                    }

                    //DEBUG
                    // if (this.readyState == 4 && this.status == 200) {
                    //     // document.getElementById('game').innerHTML = this.responseText;
                    //     document.getElementById('game').innerHTML = JSON.parse(this.responseText)['row1'][1];
                    // }  

                };
            }
        </script>

    
    </body>

<!--
{
    function: <function>,
    winner: <true/false>,
    level: <int>,
    index: <int>,
    value: <int>,
    board:
    [
        {row0 : [<cols>]},
        {row1 : [<cols>]},
        ...
    ]
}
-->




<!-- 
<table>
                        <tr id=row1>
                            <td><span id=cell1></span></td>
                            <td><span id=cell2></span></td>
                            <td class=col3><span id=cell3></span></td>
                            <td><span id=cell4></span></td>
                            <td><span id=cell5></span></td>
                            <td class=col6><span id=cell6></span></td>
                            <td><span id=cell7></span></td>
                            <td><span id=cell8></span></td>
                            <td><span id=cell9></span></td>
                        </tr>
                        <tr id=row2>
                            <td><span id=cell10></span></td>
                            <td><span id=cell11></span></td>
                            <td class=col3><span id=cell12></span></td>
                            <td><span id=cell13></span></td>
                            <td><span id=cell14></span></td>
                            <td class=col6><span id=cell15></span></td>
                            <td><span id=cell16></span></td>
                            <td><span id=cell17></span></td>
                            <td><span id=cell18></span></td>
                        </tr>
                        <tr id=row3>
                            <td><span id=cell19></span></td>
                            <td><span id=cell20></span></td>
                            <td class=col3><span id=cell21></span></td>
                            <td><span id=cell22></span></td>
                            <td><span id=cell23></span></td>
                            <td class=col6><span id=cell24></span></td>
                            <td><span id=cell25></span></td>
                            <td><span id=cell26></span></td>
                            <td><span id=cell27></span></td>
                        </tr>
                        <tr id=row4>
                            <td><span id=cell28></span></td>
                            <td><span id=cell29></span></td>
                            <td class=col3><span id=cell30></span></td>
                            <td><span id=cell31></span></td>
                            <td><span id=cell32></span></td>
                            <td class=col6><span id=cell33></span></td>
                            <td><span id=cell34></span></td>
                            <td><span id=cell35></span></td>
                            <td><span id=cell36></span></td>
                        </tr>
                        <tr id=row5>
                            <td><span id=cell37></span></td>
                            <td><span id=cell38></span></td>
                            <td class=col3><span id=cell39></span></td>
                            <td><span id=cell40></span></td>
                            <td><span id=cell41></span></td>
                            <td class=col6><span id=cell42></span></td>
                            <td><span id=cell43></span></td>
                            <td><span id=cell44></span></td>
                            <td><span id=cell45></span></td>
                        </tr>
                        <tr id=row6>
                            <td><span id=cell46></span></td>
                            <td><span id=cell47></span></td>
                            <td class=col3><span id=cell48></span></td>
                            <td><span id=cell49></span></td>
                            <td><span id=cell50></span></td>
                            <td class=col6><span id=cell51></span></td>
                            <td><span id=cell52></span></td>
                            <td><span id=cell53></span></td>
                            <td><span id=cell54></span></td>
                        </tr>
                        <tr id=row7>
                            <td><span id=cell55></span></td>
                            <td><span id=cell56></span></td>
                            <td class=col3><span id=cell57></span></td>
                            <td><span id=cell58></span></td>
                            <td><span id=cell59></span></td>
                            <td class=col6><span id=cell60></span></td>
                            <td><span id=cell61></span></td>
                            <td><span id=cell62></span></td>
                            <td><span id=cell63></span></td>
                        </tr>
                        <tr id=row8>
                            <td><span id=cell64></span></td>
                            <td><span id=cell65></span></td>
                            <td class=col3><span id=cell66></span></td>
                            <td><span id=cell67></span></td>
                            <td><span id=cell68></span></td>
                            <td class=col6><span id=cell69></span></td>
                            <td><span id=cell70></span></td>
                            <td><span id=cell71></span></td>
                            <td><span id=cell72></span></td>
                        </tr>
                        <tr id=row9>
                            <td><span id=cell73></span></td>
                            <td><span id=cell74></span></td>
                            <td class=col3><span id=cell75></span></td>
                            <td><span id=cell76></span></td>
                            <td><span id=cell77></span></td>
                            <td class=col6><span id=cell78></span></td>
                            <td><span id=cell79></span></td>
                            <td><span id=cell80></span></td>
                            <td><span id=cell81></span></td>
                        </tr>
                    </table>
 -->

</html>
